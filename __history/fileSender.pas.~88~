unit fileSender;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.ExtDlgs,
  Vcl.Menus, IdTCPConnection, IdTCPClient, IdBaseComponent, IdComponent,
  IdCustomTCPServer, IdTCPServer, Winsock, System.Win.ScktComp, Vcl.ComCtrls;

type
  TfrmMain = class(TForm)
    lbledt_IP: TLabeledEdit;
    lbledt_Password: TLabeledEdit;
    grpbx_ParamUser: TGroupBox;
    grpbx_Start: TGroupBox;
    grpbx_Receive: TGroupBox;
    btn_Receive: TButton;
    btn_Send: TButton;
    btn_NewTransfer: TButton;
    grpbx_Send: TGroupBox;
    lbledt_ReceiverIP: TLabeledEdit;
    lbledt_ReceiverPass: TLabeledEdit;
    btn_SendConfirm: TButton;
    filedlg_Send: TOpenTextFileDialog;
    btn_OpenFile: TButton;
    mainMenu: TMainMenu;
    menuFile: TMenuItem;
    menuFileNewTransfer: TMenuItem;
    menuFileClose: TMenuItem;
    menuProgram: TMenuItem;
    menuProgramNewPass: TMenuItem;
    menuHelp: TMenuItem;
    menuHelpHelp: TMenuItem;
    menuHelpAbout: TMenuItem;
    ClientSocket1: TClientSocket;
    ServerSocket1: TServerSocket;
    statBar_Receive: TStatusBar;
    statBar_Send: TStatusBar;
    procedure btn_ReceiveClick(Sender: TObject);
    procedure btn_SendClick(Sender: TObject);
    procedure btn_NewTransferClick(Sender: TObject);
    procedure btn_OpenFileClick(Sender: TObject);
    procedure btn_SendConfirmClick(Sender: TObject);
    procedure menuFileCloseClick(Sender: TObject);
    procedure menuFileNewTransferClick(Sender: TObject);
    procedure onCreate(Sender: TObject);
    procedure menuProgramNewPassClick(Sender: TObject);
    procedure ServerSocket1ClientRead(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ClientSocket1Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure ClientSocket1Read(Sender: TObject; Socket: TCustomWinSocket);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmMain: TfrmMain;
  connectionPassword: string;
  Form1: TfrmMain;
  F : TFileStream ;
  FileSize : Integer ;
  ReceiveFile , SendFile : Boolean ;
  password : String;

implementation

{$R *.dfm}

function RandomPassword(passLen: Integer): string;
var

  str: string;
  zmiana: string;
begin
  Randomize;
  //change to only four-digit code like 0000;1234;9999  ~mjasiak
  //string with all possible digits
  str    := '0123456789';
  Result := '';
  repeat
    Result := Result + str[Random(Length(str)) + 1];
  until (Length(Result) = passLen);
  connectionPassword := Result;
end;

function GetIPAddress():String;
type
  pu_long = ^u_long;
var
  varTWSAData : TWSAData;
  varPHostEnt : PHostEnt;
  varTInAddr : TInAddr;
  namebuf : Array[0..255] of ansichar;
begin
  If WSAStartup($101,varTWSAData) <> 0 Then
  Result := 'IP Address not found'
  Else Begin
    gethostname(namebuf,sizeof(namebuf));
    varPHostEnt := gethostbyname(namebuf);
    varTInAddr.S_addr := u_long(pu_long(varPHostEnt^.h_addr_list^)^);
    Result :=inet_ntoa(varTInAddr);
  End;
  WSACleanup;
end;

procedure TfrmMain.btn_NewTransferClick(Sender: TObject);
begin
   grpbx_Send.Visible := False;
   grpbx_Receive.Visible := False;
end;

procedure TfrmMain.btn_OpenFileClick(Sender: TObject);
begin
if filedlg_Send.Execute() then
F := TFileStream.Create(filedlg_Send.FileName,fmOpenRead);
end;

procedure TfrmMain.btn_ReceiveClick(Sender: TObject);
begin
grpbx_Receive.Visible := True;
ClientSocket1.Active := False;
ServerSocket1.Port := 8080;
ServerSocket1.Active := True;
statBar_Receive.Panels[0].Text := 'Oczekiwanie na po³¹czenie...';
end;

procedure TfrmMain.btn_SendClick(Sender: TObject);
begin
grpbx_Send.Visible := True;
end;

procedure TfrmMain.btn_SendConfirmClick(Sender: TObject);
begin
ServerSocket1.Active := False;
ClientSocket1.Port := 8080;
ClientSocket1.Address := lbledt_ReceiverIP.Text;
ClientSocket1.Active := True;
end;


procedure TfrmMain.ClientSocket1Connect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
Socket.SendText(lbledt_ReceiverPass.Text);
end;

procedure TfrmMain.ClientSocket1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  Read: Integer ;
  Buf : array [1..1024] of Char ;
  FileName : String ;
begin
if Socket.ReceiveText = 'Send' then
SendFile := True;
while F.Position < F.Size do  // 3
  begin
    Application.ProcessMessages ;  // 4
    if not SendFile then Break ;  // 5
    Sleep(10) ;

    Read := F.Read(Buf , SizeOf(Buf)) ;  // 6
    ClientSocket1.Socket.SendBuf(Buf , Read) ; // 7
    statBar_Send.Panels[0].Text := 'Przesy³am plik, postêp: ' +
FormatFloat('0.00' , (F.Position / F.Size) * 100) + '%' ;  // 8
  end ;
  if F.Position < F.Size then
  statBar_Send.Panels[0].Text := 'Wysy³anie pliku przerwane.'
end;

procedure TfrmMain.menuFileCloseClick(Sender: TObject);
begin
Application.Terminate;
end;

procedure TfrmMain.menuFileNewTransferClick(Sender: TObject);
begin
btn_NewTransfer.Click();
end;

procedure TfrmMain.menuProgramNewPassClick(Sender: TObject);
begin
password := RandomPassword(4);
lbledt_Password.Text := password;
end;

procedure TfrmMain.onCreate(Sender: TObject);
begin
password  := RandomPassword(4);
lbledt_IP.Text := GetIPAddress();
lbledt_Password.Text := password;
end;


procedure TfrmMain.ServerSocket1ClientRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
  Read : Integer ;
  Buf : array [1..1024] of Char ;
  FileName : String ;
begin
if password = Socket.ReceiveText then
begin
statBar_Receive.Panels[0].Text := 'Uda³o siê po³¹czyæ...';
Socket.SendText('Send');
ReceiveFile:= True;
end;
if ReceiveFile = True then
end;


end.
